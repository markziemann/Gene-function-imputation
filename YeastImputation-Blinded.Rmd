---
title: "Yeast Gene Imputation (blinded data)"
author: "M.Soria"
date: "19/10/2020"
output: html_document
---
</br>

***

##### The following code imputes function on genes from Sacharromyces cerevisiae. Some of the genes were randomly chosen and "blinded" for testing recall.
***

</br>

### Prerequisite libraries
```{r Libraries, echo=TRUE}
suppressPackageStartupMessages({
    library(R.utils)
    library(dplyr)
    library(tidyr)
    library(data.table)
    library(RColorBrewer)
    library(gplots)
    library(Polychrome)
    library(tidyverse)
    library(caret)
})

source("functions.R")

```
</br>

### Load Pre-requisite RDS files 
```{r echo=TRUE}
file_logcounts_PASS <- "logcounts_PASS.rds"
file_agg <- "agg.rds"
file_clusters <- "clusters.rds"
file_GO <-"GO_table.rds"
file_GO_allClusters <- "GOterms_allClusters.rds"
file_corr_allClusters <- "corr_allClusters.rds"
file_wGO_allClusters <- "wGO_allClusters.rds"
file_GOterms_perCl <- "GOterms_perCl.rds"
file_cluster_cuts <- "cluster_cuts.rds"

logcounts <- readRDS(file_logcounts_PASS)
agg <- readRDS(file_agg)
clusters <- readRDS(file_clusters)
GO_table <- readRDS(file_GO)
GO_allClusters <-  readRDS(file_GO_allClusters)
corr_allClusters <-  readRDS(file_corr_allClusters)
wGO_allClusters <- readRDS(file_wGO_allClusters)
GOterms_perCl <- readRDS(file_GOterms_perCl)
cluster_cuts <- file_cluster_cuts
```

### 1. Blinding known GO terms

```{r}
#Fraction of the total number of genes to be blinded
nfolds <- 10

set.seed(42)
folds <- sample(1:nfolds, nrow(GO_table), replace = TRUE)
#fix rownames
dict_folds <- data.frame(GO_table$GeneID, folds)

saveRDS(dict_blind, "dict_folds.rds")


# Make a data matrix with the blinded genes = 0
which_fold <- 3

ind_blinded <- which(dict_folds$folds == which_fold)
GO_blinded <- GO_table

GO_blinded[ind_blinded, 2:ncol(GO_blinded)] = 0

```

### 3. Impute using blinded GO terms 

```{r }

# Get the GO terms by cluster using the blinded data 
# and the GO list per cluster

GO_blindedClusters <- GO_per_cl_blinded(GO_blinded, 
                        clusters, GOterms_perCl, 100)

GO_blindedClCuts <- function(){
    
}


wGO_blinded <- impute(cl_GOall = GO_blindedClusters, 
     corr_clAll = corr_allClusters,
     clust_total = 100, thresh = 0.02)

```
</br>

### 4. Measures of performance 

```{r}

# per cluster

stats_perCl3 <- stats_cl(wGO_allClusters, wGO_blinded, 100)

stats_perCl3[["Cluster50"]]


#for the entire data frame

stats_final7 <- stats_all(stats_perCl7)

stats_final3

# does not work for other R server (R version 3.6.3 (2020-02-29)
# Platform: x86_64-pc-linux-gnu (64-bit))
# stats_df2 <- do.call(rbind.data.frame, stats_perCl)

# works for both servers
stats_df3 <- as.data.frame(t(as.data.frame(lapply(stats_perCl, unlist))))

sum(stats_df$TP)

```

### 5. K-Fold with Global perfomance metrics (per threshold)

```{r}

start.time <- Sys.time()

kfold <- cross_val(n=10, GO_annot=GO_table, clusters=clusters,
                      GO_list_perCl=GOterms_perCl, 
                      corr_clAll=corr_allClusters,
                      wGO_allClusters=wGO_allClusters,
                      clust_total=100, thresh=0.02)

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken # 1.801095 hours

kfold_50 <- cross_val(n=10, GO_annot=GO_table, clusters=clusters,
                      GO_list_perCl=GOterms_perCl, 
                      corr_clAll=corr_allClusters,
                      wGO_allClusters=wGO_allClusters,
                      clust_total=100, thresh=0.5)

kfold_90 <- cross_val(n=10, GO_annot=GO_table, clusters=clusters,
                      GO_list_perCl=GOterms_perCl, 
                      corr_clAll=corr_allClusters,
                      wGO_allClusters=wGO_allClusters,
                      clust_total=100, thresh=0.9)

kfold_df <- as.data.frame(do.call(rbind, kfold))
kfold_90_df <- as.data.frame(do.call(rbind, kfold_90))
kfold_50_df <- as.data.frame(do.call(rbind, kfold_50))

kfold_50_ave <- mean(unlist(kfold_50_df$Precision))



cross_val_thresh <- function(interval){
    
    kfold_gobal <- list()
    
    thresh <- seq(from = 0.5, to = 1, by = interval)
    
    for (i in thresh){
        
        kfold <- cross_val(n=10, GO_annot=GO_table, clusters=clusters,
                      GO_list_perCl=GOterms_perCl, 
                      corr_clAll=corr_allClusters,
                      wGO_allClusters=wGO_allClusters,
                      clust_total=100, thresh= i)
        
        kfold_df <- as.data.frame(do.call(rbind, kfold))
        
        Sensitivity <- mean(unlist(kfold_df$Sensitivity))
        Specificity <- mean(unlist(kfold_df$Specificity))
        Precision <- mean(unlist(kfold_df$Precision))
        Accuracy <- mean(unlist(kfold_df$Accuracy))
        F1_Score <- mean(unlist(kfold_df$`F1 Score`))
        
        
        kfold_gobal[[paste0(i)]][["DF"]] <- kfold_df
        kfold_gobal[[paste0(i)]][["Sensitivity"]] <- Sensitivity
        kfold_gobal[[paste0(i)]][["Specificity"]] <- Specificity
        kfold_gobal[[paste0(i)]][["Precision"]] <- Precision
        kfold_gobal[[paste0(i)]][["Accuracy"]] <- Accuracy
        kfold_gobal[[paste0(i)]][["F1_Score"]] <- F1_Score
    }
    return(kfold_gobal)
}


start.time <- Sys.time()

kfold_mult <- cross_val_thresh(0.4)

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken # 5.564071 hours

start.time <- Sys.time()

kfold_mult2 <- cross_val_thresh(0.2)

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken 
```

### 6. ROC and AUC 

```{r}


```


### Session Information 

```{r Session Info, echo=FALSE}
sessionInfo()
```
