---
title: "Yeast Gene Imputation (blinded data)"
author: "M.Soria"
date: "19/10/2020"
output: html_document
---
</br>

***

##### The following code imputes function on genes from Sacharromyces cerevisiae. Some of the genes were randomly chosen and "blinded" for testing recall.
***

</br>

### Prerequisite libraries
```{r Libraries, echo=TRUE}
suppressPackageStartupMessages({
    library(R.utils)
    library(dplyr)
    library(tidyr)
    library(data.table)
    library(RColorBrewer)
    library(gplots)
    library(Polychrome)
    library(tidyverse)
    library(caret)
    library(ggplot2)
    library(reshape2)
    library(tools)
    library (igraph)
})

source("functions.R")

```
</br>

### Load Pre-requisite RDS files 
```{r echo=TRUE}
file_PASS <- "tmm_agg_s.rds"
file_cl_s <- "mycl_s_aggCL_sp.rds"
file_cl_tmm_sp <- "mycl_tmm_aggCL_sp.rds"
file_cl_tmm_pr <- "mycl_tmm_aggCL_pr.rds"
file_GO <-"GO_table.rds"
file_cuttree_values <- "cuttree_values.rds"
file_hr_s <- "s_aggCL_sp.rds"
file_hr_tmm_sp <- "tmm_aggCL_sp.rds"
file_hr_tmm_pr <- "tmm_aggCL_pr.rds"

tmm_agg_s <- readRDS(file_PASS)

clusters_s <- readRDS(file_cl_s)
clusters_tmm_sp <- readRDS(file_cl_tmm_sp)
clusters_tmm_pr <- readRDS(file_cl_tmm_pr)
HR_s <- readRDS(file_hr_s)
HR_tmm_sp <- readRDS(file_hr_tmm_sp)
HR_tmm_pr <- readRDS(file_hr_tmm_pr)
GO_table <- readRDS(file_GO)
```

### 1. Blinding known GO terms

```{r}
#Fraction of the total number of genes to be blinded
nfolds <- 10

set.seed(42)
folds <- sample(1:nfolds, nrow(GO_table), replace = TRUE)
#fix rownames
dict_folds <- data.frame(GO_table$GeneID, folds)

saveRDS(dict_folds, "dict_folds.rds")


# Make a data matrix with the blinded genes = 0
which_fold <- 3

ind_blinded <- which(dict_folds$folds == which_fold)
GO_blinded <- GO_table

GO_blinded[ind_blinded, 2:ncol(GO_blinded)] = 0

```

### 2a. Determine min-max cut value through trial and error to get 20 to 2000 total clusters

```{r }

cuttree_values_ave <- cl_lengthCut(hr=hr, min=4, max=2000, interval=2)
saveRDS(cuttree_values_ave, "cuttree_values_aves.rds")

# cuttree_values_s <- cl_lengthCut(hr=hr, min=1.31, max=4.8, interval=0.001)
# saveRDS(cuttree_values_s, "cuttree_values.rds")

```
</br>


### 2b. Coarse Sweep for Spearman + complete linkage (SandC)
The following code will perform a K-fold validation for the imputation process which uses Pearson method to measure the distance matrix and complete as linkage method during the clustering process. 

```{r}
# Coarse sweep of the following parameters: cluster total(20, 50, 200, 500) and threshold (0.1, 0.4, 0.8)

cl_list <- c(20, 50, 100, 300, 500)
thresh_list <- c(0.1, 0.4, 0.8)

# Scaled
CS_s <- kfold(cl_list, thresh_list, cuttree_values_ave, tmm_agg_s, GO_table, GO_blinded)
    saveRDS(CS_s, "CS_s.rds")
    

```

### 2c. Summary of performace measures for Pearson + complete linkage

```{r}

dat_list_s <- lapply(CS_s, function(x) x[names(x)!="Index_folds"])
dat_list_tmm_pr <- lapply(CS_tmm_pr, function(x) x[names(x)!="Index_folds"])
dat_list_tmm_sp <- lapply(CS_tmm_sp, function(x) x[names(x)!="Index_folds"])

# List the all the mean predicton scores for each parameter 
summary_all_s <- summary_Csweep(dat_list_s)
saveRDS(summary_all_s, "summary_all_s.rds")

summary_all_tmm_pr <- summary_Csweep(dat_list_tmm_pr)
saveRDS(summary_all_tmm_pr, "summary_all_tmm_pr.rds")

summary_all_tmm_sp <- summary_Csweep(dat_list_tmm_sp)
saveRDS(summary_all_tmm_sp, "summary_all_tmm_sp.rds")


```

### 5. Visualizations

```{r}

# cut tree value vs Total Clusters – line diagram
cuttree_totals_df <- function(cuttree_values, x){
  as.data.frame(as.numeric(names(cuttree_values)))
  m <- list()
  for (i in 1:length(cuttree_values)){
    x <- cuttree_values[[i]][["Cut_value"]]
    m[[i]] <- x
  }
  cuttree_totals_df$CuttreeVal <- as.numeric(m)
  colnames(cuttree_totals_df)[1] <- "ClTot"
  n <- paste0("Data/", x, "cuttree_vs_clTotal.png")
  png(as.character(n),
    width = 5*300,        # 5 x 300 pixels
    height = 5*300,
    res = 300,            # 300 pixels per inch
    pointsize = 8)        # smaller font size
  
  ggplot(cuttree_totals_df, aes(x=CuttreeVal, y=ClTot)) +
    geom_line() + ylab("Total Number of Clusters") +
    xlab("Cuttree Values") +
    ggtitle("Cuttree Value vs Total Number of Clusters") +
    theme(plot.title = element_text(hjust = 0.5))
  
  dev.off()
}

cuttree_totals_df(cuttree_values_s, x="cuttree_values_s")
cuttree_totals_df(cuttree_values_tmm_pr, x="cuttree_values_tmm_pr") 
cuttree_totals_df(cuttree_values_tmm_sp, x="cuttree_values_tmm_sp") 
 


# Total genes per cluster  – violin plot
c_violin <- function(cuttree_values,x){
  
  clTotals <- do.call(rbind.data.frame, sapply(cuttree_values, "[[", 3))
  clTotals$ClusterSize <- as.factor(as.numeric(str_extract_all(rownames(clTotals), "^[:digit:]*(?=.)")))
  clTotals$ClusterID <- as.numeric(str_extract_all(rownames(clTotals), "(?=.)\\d+$"))
  colnames(clTotals)[1] <- "TotalGenes"
  rownames(clTotals) <- c()
  
  # Filter according to cluster size
  cluster20_100 <- clTotals[clTotals$ClusterSize %in% c(20,50,100),]
  cluster200_500 <- clTotals[clTotals$ClusterSize %in% c(200, 300, 500),]
  cluster800_1500 <- clTotals[clTotals$ClusterSize %in% c(800, 1000, 1500),]
  
  n <- paste0("Data/", x, "Violinplots.pdf")
  
  pdf(as.character(n))
  
  ggplot(cluster20_100, aes(x=ClusterSize, y=TotalGenes, fill=ClusterSize)) +
    geom_violin(trim=FALSE) + ylab("Total Number of Genes") +
    xlab("Cluster Size") +
    ggtitle("Distibution of genes per cluster size (20 to 100)") +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_boxplot(width=0.1, fill="white") + theme_minimal() +
    scale_fill_brewer(palette="Blues")
    
  ggplot(cluster200_500, aes(x=ClusterSize, y=TotalGenes, fill=ClusterSize)) +
    geom_violin(trim=FALSE) + ylab("Total Number of Genes") +
    xlab("Cluster Size") +
    ggtitle("Distibution of genes per cluster size (200 to 500)") +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_boxplot(width=0.1, fill="white") + theme_minimal() +
    scale_fill_brewer(palette="Dark2")
  
  ggplot(cluster800_1500, aes(x=ClusterSize, y=TotalGenes, fill=ClusterSize)) +
    geom_violin(trim=FALSE) + ylab("Total Number of Genes") +
    xlab("Cluster Size") +
    ggtitle("Distibution of genes per cluster size (800 to 1500)") +
    theme(plot.title = element_text(hjust = 0.5)) +
     geom_boxplot(width=0.1, fill="white") + theme_minimal() + 
    scale_fill_brewer(palette="RdBu")
  
  dev.off()
}

c_violin(cuttree_values_s, x="cuttree_values_s") 
c_violin(cuttree_values_tmm_pr, x="cuttree_values_tmm_pr") 
c_violin(cuttree_values_tmm_sp, x="cuttree_values_tmm_sp") 

```

### Session Information 

```{r Session Info, echo=FALSE}
sessionInfo()
```
